name: Safari History Sync CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-deploy:
    name: Build, Test, and Deploy
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            SafariHistorySync/package-lock.json
      
      - name: Install dependencies
        run: |
          # Install root dependencies
          npm install
          
          # Install Xcode project dependencies
          cd SafariHistorySync
          npm install
          cd ..
      
      - name: Build extension
        run: |
          cd SafariHistorySync
          npm run build
      
      - name: Run tests
        id: run-tests
        run: |
          cd SafariHistorySync
          npm run test:all
        # This allows the workflow to continue to the artifact upload step even if tests fail
        continue-on-error: true

      - name: Check test results
        if: steps.run-tests.outcome != 'success'
        run: |
          echo "::error::Tests failed! Check the test logs for details."
          exit 1
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        # Always upload artifacts, even if previous steps failed
        if: always()
        with:
          name: safari-history-sync-artifacts
          path: |
            SafariHistorySync/dist/*.bundle.js
            SafariHistorySync/test/temp-instance-*/*.log
            SafariHistorySync/test/temp-instance-*/LOG*
      
      # This step would be used in a real deployment scenario
      # - name: Deploy to App Store
      #   if: github.ref == 'refs/heads/main'
      #   run: |
      #     echo "Deploying to App Store..."
      #     # Add deployment steps here